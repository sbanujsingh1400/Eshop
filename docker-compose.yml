version: '3.8'

networks:
  e-shop-network:
    driver: bridge

services:
  
  user-ui:
    container_name: e-shop-user-ui
    image: ghcr.io/sbanujsingh1400/eshop-user-ui:latest
    env_file:
      - ./.env       
    ports:
      - "3001:3001"
    environment:
      - PORT=3001
      - NODE_ENV=production
    networks:
      - e-shop-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3001/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  seller-ui:
    container_name: e-shop-seller-ui
    image: ghcr.io/sbanujsingh1400/eshop-seller-ui:latest
    env_file:
      - ./.env   
    ports:
      - "3000:3000"
    environment:
      - PORT=3000
      - NODE_ENV=production
    networks:
      - e-shop-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
  
  api-gateway:
    container_name: e-shop-api-gateway
    image: ghcr.io/sbanujsingh1400/eshop-api-gateway:latest
    env_file:
      - ./.env    
    ports:
      - "8080:8080"
    environment:
      - PORT=8080
      - NODE_ENV=production
    networks:
      - e-shop-network
    depends_on:
      auth-service:
        condition: service_healthy
      product-service:
        condition: service_healthy
      order-service:
        condition: service_healthy
      chatting-service:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  auth-service:
    container_name: e-shop-auth-service
    image: ghcr.io/sbanujsingh1400/eshop-auth-service:latest
    env_file:
      - ./.env      
    environment:
      - PORT=6001
      - NODE_ENV=production
    networks:
      - e-shop-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:6001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  product-service:
    container_name: e-shop-product-service
    image: ghcr.io/sbanujsingh1400/eshop-product-service:latest
    env_file:
      - ./.env      
    environment:
      - PORT=6002
      - NODE_ENV=production
    networks:
      - e-shop-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:6002/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  order-service:
    container_name: e-shop-order-service
    image: ghcr.io/sbanujsingh1400/eshop-order-service:latest
    env_file:
      - ./.env      
    environment:
      - PORT=6004
      - NODE_ENV=production
    networks:
      - e-shop-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:6004/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  chatting-service:
    container_name: e-shop-chatting-service
    image: ghcr.io/sbanujsingh1400/eshop-chatting-service:latest
    env_file:
      - ./.env      
    environment:
      - PORT=6006
      - NODE_ENV=production
    ports:
      - "6006:6006"  
    networks:
      - e-shop-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:6006/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  kafka-service:
    container_name: e-shop-kafka-service
    image: ghcr.io/sbanujsingh1400/eshop-kafka-service:latest
    env_file:
      - ./.env      
    networks:
      - e-shop-network
    restart: unless-stopped