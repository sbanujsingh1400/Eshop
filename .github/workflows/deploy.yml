name: Build, Push, and Deploy E-Shop (v9 - File-based)

on:
  push:
    branches: [ master ]

env:
  REGISTRY: ghcr.io
  IMAGE_OWNER: ${{ github.repository_owner }}

jobs:
  build-base:
    name: Build Base Image
    runs-on: ubuntu-latest
    outputs:
      built: ${{ steps.output.outputs.built }}
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      - id: check
        uses: tj-actions/changed-files@v44
        with:
          files: |
            Dockerfile.base
            package.json
            package-lock.json
            prisma/**/*
            nx.json
            tsconfig.base.json
          base_sha: ${{ github.event.before || 'HEAD~1' }}

      - if: steps.check.outputs.any_changed == 'true'
        uses: docker/login-action@v3
        with: { registry: ${{ env.REGISTRY }}, username: ${{ github.actor }}, password: ${{ secrets.GHCR_PAT }} }

      - if: steps.check.outputs.any_changed == 'true'
        uses: docker/setup-buildx-action@v3

      - id: build
        if: steps.check.outputs.any_changed == 'true'
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile.base
          push: true
          no-cache: true
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_OWNER }}/eshop-base:latest
          secrets: |
            GIT_AUTH_TOKEN=${{ secrets.GHCR_PAT }}

      - id: output
        if: always()
        run: |
          if [ "${{ steps.build.outcome }}" == "success" ]; then
            echo "built=true" >> $GITHUB_OUTPUT
          else
            echo "built=false" >> $GITHUB_OUTPUT
          fi

  # ---- Reusable Template for All Services ----
  build-service:
    name: Build (${{ matrix.app }})
    runs-on: ubuntu-latest
    needs: [build-base]
    strategy:
      fail-fast: false
      matrix:
        app: [user-ui, seller-ui, api-gateway, auth-service, product-service, order-service, chatting-service, kafka-service]
    outputs:
      built: ${{ steps.out.outputs.built }}

    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      - id: check
        uses: tj-actions/changed-files@v44
        with:
          files: |
            apps/${{ matrix.app }}/**/*
            packages/**/*
            ${{ matrix.app == 'user-ui' || matrix.app == 'seller-ui' && 'Dockerfile.frontend' || 'Dockerfile.backend' }}
          base_sha: ${{ github.event.before || 'HEAD~1' }}

      - id: decide
        run: |
          if [ "${{ steps.check.outputs.any_changed }}" == "true" ] || [ "${{ needs.build-base.outputs.built }}" == "true" ]; then
            echo "run_build=true" >> $GITHUB_OUTPUT
          else
            echo "run_build=false" >> $GITHUB_OUTPUT
          fi

      - if: steps.decide.outputs.run_build == 'true'
        uses: docker/login-action@v3
        with: { registry: ${{ env.REGISTRY }}, username: ${{ github.actor }}, password: ${{ secrets.GHCR_PAT }} }

      - if: steps.decide.outputs.run_build == 'true'
        uses: docker/setup-buildx-action@v3

      - id: build
        if: steps.decide.outputs.run_build == 'true'
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ${{ (matrix.app == 'user-ui' || matrix.app == 'seller-ui') && './Dockerfile.frontend' || './Dockerfile.backend' }}
          build-args: |
            APP_NAME=${{ matrix.app }}
            NEXT_PUBLIC_SERVER_URI=${{ vars.NEXT_PUBLIC_SERVER_URI }}
            NEXT_PUBLIC_CHATTING_WEBSOCKET_URI=${{ vars.NEXT_PUBLIC_CHATTING_WEBSOCKET_URI }}
            NEXT_PUBLIC_STRIPE_PUBLIC_KEY=${{ secrets.NEXT_PUBLIC_STRIPE_PUBLIC_KEY }}
            NEXT_PUBLIC_USER_URI=${{ vars.NEXT_PUBLIC_USER_URI }}
            NEXT_PUBLIC_SELLER_URI=${{ vars.NEXT_PUBLIC_SELLER_URI }}
          push: true
          no-cache: true
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_OWNER }}/eshop-${{ matrix.app }}:latest
          secrets: |
            GIT_AUTH_TOKEN=${{ secrets.GHCR_PAT }}

      - id: out
        if: always()
        run: |
          if [ "${{ steps.build.outcome }}" == "success" ]; then
            echo "built=true" >> $GITHUB_OUTPUT
          else
            echo "built=false" >> $GITHUB_OUTPUT
          fi

  deploy:
    name: Deploy Affected Services
    runs-on: ubuntu-latest
    needs: [build-service]
    if: always()
    steps:
      - name: Find all changed services
        id: list
        run: |
          SERVICES=""
          for service in user-ui seller-ui api-gateway auth-service product-service order-service chatting-service kafka-service; do
            built=$(jq -r ".\"build-service\".matrix[$service].built" <<< '${{ toJson(needs) }}' 2>/dev/null || echo "false")
            if [ "$built" == "true" ]; then
              SERVICES="$SERVICES $service"
            fi
          done
          SERVICES=$(echo "$SERVICES" | xargs)
          echo "affected=$SERVICES" >> $GITHUB_OUTPUT
          echo "Deploying: $SERVICES"

      - if: steps.list.outputs.affected != ''
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USER }}
          key: ${{ secrets.VM_SSH_KEY }}
          script: |
            cd ~/Eshop
            echo ${{ secrets.GHCR_PAT }} | docker login ${{ env.REGISTRY }} -u ${{ github.actor }} --password-stdin
            git pull
            echo "${{ secrets.PROD_ENV_FILE }}" > .env
            SERVICES="${{ steps.list.outputs.affected }}"
            docker compose pull $SERVICES
            docker compose up -d $SERVICES
            docker image prune -f

      - if: steps.list.outputs.affected == ''
        run: echo "✅ No changes detected — skipping deployment."
