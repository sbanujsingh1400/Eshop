name: Build, Push, and Deploy E-Shop (v8 - File-based)

on:
  push:
    branches: [ master ]

env:
  REGISTRY: ghcr.io
  IMAGE_OWNER: ${{ github.repository_owner }}

jobs:
  # 1️⃣ Build base image only if core files changed
  build-base:
    runs-on: ubuntu-latest
    outputs:
      built: ${{ steps.set-output.outputs.built }}
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      - id: check-files
        uses: tj-actions/changed-files@v44
        with:
          files: |
            Dockerfile.base
            package.json
            package-lock.json
            prisma/**/*
            nx.json
            tsconfig.base.json
          base_sha: ${{ github.event.before || 'HEAD~1' }}

      - if: steps.check-files.outputs.any_changed == 'true'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GHCR_PAT }}

      - if: steps.check-files.outputs.any_changed == 'true'
        uses: docker/setup-buildx-action@v3

      - id: build-step
        if: steps.check-files.outputs.any_changed == 'true'
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile.base
          push: true
          no-cache: true
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_OWNER }}/eshop-base:latest
          secrets: |
            GIT_AUTH_TOKEN=${{ secrets.GHCR_PAT }}

      - id: set-output
        if: always()
        run: |
          if [ "${{ steps.build-step.outcome }}" == "success" ]; then
            echo "built=true" >> $GITHUB_OUTPUT
          else
            echo "built=false" >> $GITHUB_OUTPUT
          fi

  # 2️⃣ Template Reusable Job for Any Service
  build-service:
    name: Build (${{ matrix.service }})
    runs-on: ubuntu-latest
    needs: [build-base]
    outputs:
      built: ${{ steps.out.outputs.built }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - service: user-ui
            dockerfile: Dockerfile.frontend
            type: frontend
          - service: seller-ui
            dockerfile: Dockerfile.frontend
            type: frontend
          - service: api-gateway
            dockerfile: Dockerfile.backend
            type: backend
          - service: auth-service
            dockerfile: Dockerfile.backend
            type: backend
          - service: product-service
            dockerfile: Dockerfile.backend
            type: backend
          - service: order-service
            dockerfile: Dockerfile.backend
            type: backend
          - service: chatting-service
            dockerfile: Dockerfile.backend
            type: backend
          - service: kafka-service
            dockerfile: Dockerfile.backend
            type: backend

    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      - id: check
        uses: tj-actions/changed-files@v44
        with:
          files: |
            apps/${{ matrix.service }}/**/*
            packages/**/*
            ${{ matrix.dockerfile }}
          base_sha: ${{ github.event.before || 'HEAD~1' }}

      - id: decide
        run: |
          if [ "${{ steps.check.outputs.any_changed }}" == "true" ] || [ "${{ needs.build-base.outputs.built }}" == "true" ]; then
            echo "run_build=true" >> $GITHUB_OUTPUT
          else
            echo "run_build=false" >> $GITHUB_OUTPUT
          fi

      - if: steps.decide.outputs.run_build == 'true'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GHCR_PAT }}

      - if: steps.decide.outputs.run_build == 'true'
        uses: docker/setup-buildx-action@v3

      - id: build
        if: steps.decide.outputs.run_build == 'true'
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./${{ matrix.dockerfile }}
          build-args: |
            APP_NAME=${{ matrix.service }}
            NEXT_PUBLIC_SERVER_URI=${{ vars.NEXT_PUBLIC_SERVER_URI }}
            NEXT_PUBLIC_CHATTING_WEBSOCKET_URI=${{ vars.NEXT_PUBLIC_CHATTING_WEBSOCKET_URI }}
            NEXT_PUBLIC_STRIPE_PUBLIC_KEY=${{ secrets.NEXT_PUBLIC_STRIPE_PUBLIC_KEY }}
            NEXT_PUBLIC_USER_URI=${{ vars.NEXT_PUBLIC_USER_URI }}
            NEXT_PUBLIC_SELLER_URI=${{ vars.NEXT_PUBLIC_SELLER_URI }}
          push: true
          no-cache: true
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_OWNER }}/eshop-${{ matrix.service }}:latest
          secrets: |
            GIT_AUTH_TOKEN=${{ secrets.GHCR_PAT }}

      - id: out
        if: always()
        run: |
          if [ "${{ steps.build.outcome }}" == "success" ]; then
            echo "built=true" >> $GITHUB_OUTPUT
          else
            echo "built=false" >> $GITHUB_OUTPUT
          fi

  # 3️⃣ Deploy only what was built
  deploy:
    name: Deploy Updated Containers
    runs-on: ubuntu-latest
    needs: [build-service]
    if: always()
    steps:
      - name: Aggregate Built Services
        id: list
        run: |
          SERVICES=""
          for service in user-ui seller-ui api-gateway auth-service product-service order-service chatting-service kafka-service; do
            built=$(jq -r ".\"build-service\".matrix[$service].built" <<< '${{ toJson(needs) }}' 2>/dev/null || echo "false")
            if [ "$built" == "true" ]; then
              SERVICES="$SERVICES $service"
            fi
          done
          SERVICES=$(echo "$SERVICES" | xargs)
          echo "affected=$SERVICES" >> $GITHUB_OUTPUT
          echo "Services to deploy: $SERVICES"

      - name: Deploy to VM
        if: steps.list.outputs.affected != ''
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USER }}
          key: ${{ secrets.VM_SSH_KEY }}
          script: |
            cd ~/Eshop
            echo ${{ secrets.GHCR_PAT }} | docker login ${{ env.REGISTRY }} -u ${{ github.actor }} --password-stdin
            git pull
            echo "${{ secrets.PROD_ENV_FILE }}" > .env

            SERVICES="${{ steps.list.outputs.affected }}"
            echo "Pulling updated services: $SERVICES"
            docker compose pull $SERVICES
            docker compose up -d $SERVICES
            docker image prune -f

      - name: Skip Message
        if: steps.list.outputs.affected == ''
        run: echo "✅ No service changes detected. Skipping deployment."
