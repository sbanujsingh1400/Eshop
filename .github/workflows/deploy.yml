name: Build, Push, and Deploy E-Shop (Optimized)

on:
  push:
    branches: [ master ]

env:
  REGISTRY: ghcr.io
  IMAGE_OWNER: ${{ github.repository_owner }}
  ALL_APPS: >
    user-ui seller-ui api-gateway auth-service product-service order-service chatting-service kafka-service

jobs:
  # ────────────────────────────────────────────────────────────────
  # 1️⃣ Detect what actually changed
  # ────────────────────────────────────────────────────────────────
  determine-affected:
    name: Determine Affected Apps
    runs-on: ubuntu-latest
    outputs:
      affected_apps_json: ${{ steps.get-affected.outputs.affected_apps_json }}
      affected_apps_list: ${{ steps.get-affected.outputs.affected_apps_list }}
      build_base: ${{ steps.set-base-flag.outputs.build_base }}

    steps:
      - name: Checkout full repo history
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"

      - name: Install dependencies
        run: npm install --legacy-peer-deps

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Check for base image–related changes
        id: check-base
        uses: tj-actions/changed-files@v44
        with:
          files: |
            package.json
            package-lock.json
            Dockerfile.base
            nx.json
            tsconfig.base.json

      - name: Set base build flag
        id: set-base-flag
        run: |
          if [ "${{ steps.check-base.outputs.any_changed }}" == 'true' ]; then
            echo "build_base=true" >> $GITHUB_OUTPUT
          else
            echo "build_base=false" >> $GITHUB_OUTPUT
          fi

      - name: Get affected Nx apps
        id: get-affected
        run: |
          if [ "${{ steps.set-base-flag.outputs.build_base }}" == "true" ]; then
            echo "Base image or core config changed → rebuilding all apps"
            AFFECTED_LIST="${{ env.ALL_APPS }}"
          else
            echo "Detecting changed apps using Nx..."
            AFFECTED_LIST=$(npx nx print-affected --base=HEAD~1 --head=HEAD --target=build --select=projects)
          fi

          echo "Affected apps (raw):"
          echo "$AFFECTED_LIST"

          if [ -z "$AFFECTED_LIST" ]; then
            echo "No affected apps found."
            echo "affected_apps_json=[]" >> $GITHUB_OUTPUT
            echo "affected_apps_list=" >> $GITHUB_OUTPUT
            exit 0
          fi

          JSON_ARRAY=$(echo "$AFFECTED_LIST" | jq -R . | jq -s .)
          echo "affected_apps_json=$JSON_ARRAY" >> $GITHUB_OUTPUT
          echo "affected_apps_list=$AFFECTED_LIST" >> $GITHUB_OUTPUT

  # ────────────────────────────────────────────────────────────────
  # 2️⃣ Build base image (only if required)
  # ────────────────────────────────────────────────────────────────
  build-base:
    name: Build Base Image
    runs-on: ubuntu-latest
    needs: determine-affected
    if: needs.determine-affected.outputs.build_base == 'true'
    permissions:
      contents: read
      packages: write

    steps:
      - uses: actions/checkout@v4

      - uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GHCR_PAT }}

      - uses: docker/setup-buildx-action@v3
        with:
          driver-opts: network=host

      - name: Build & Push eshop-base
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile.base
